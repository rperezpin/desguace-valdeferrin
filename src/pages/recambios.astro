---
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import products from '../data/products.json';

const categorias = [...new Set(products.map(p => p.categoria))];
const marcas = [...new Set(products.map(p => p.marca))];
---

<Layout
  title="Recambios de Segunda Mano"
  description="Catalogo de recambios de segunda mano con garantia. Piezas de coche revisadas: motores, faros, paragolpes, cajas de cambios y mas. Envio a toda Espana."
>
  <!-- Page Header -->
  <section class="bg-primary-700 text-white py-10">
    <div class="container-site">
      <h1 class="font-display font-bold text-3xl md:text-4xl mb-2">Recambios de Segunda Mano</h1>
      <p class="text-primary-200">Piezas revisadas con garantia. Envio a toda Espana en 24-48h.</p>
    </div>
  </section>

  <section class="section-padding">
    <div class="container-site">
      <div class="lg:flex lg:gap-8">
        <!-- Sidebar Filters -->
        <aside class="lg:w-64 shrink-0 mb-8 lg:mb-0">
          <div class="bg-white rounded-xl p-6 shadow-sm border border-grey-200 sticky top-24">
            <h2 class="font-display font-bold text-sm uppercase tracking-wider text-dark mb-4">Filtros</h2>

            <!-- Search -->
            <div class="mb-6">
              <label class="text-xs font-semibold text-grey-600 uppercase tracking-wider block mb-2">Buscar</label>
              <input
                type="text"
                id="filter-search"
                placeholder="Nombre de pieza..."
                class="w-full px-3 py-2 text-sm border border-grey-200 rounded-md outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
              />
            </div>

            <!-- Categoria -->
            <div class="mb-6">
              <label class="text-xs font-semibold text-grey-600 uppercase tracking-wider block mb-2">Categoria</label>
              <select id="filter-cat" class="w-full px-3 py-2 text-sm border border-grey-200 rounded-md outline-none focus:border-primary-500">
                <option value="">Todas</option>
                {categorias.map(c => <option value={c}>{c}</option>)}
              </select>
            </div>

            <!-- Marca -->
            <div class="mb-6">
              <label class="text-xs font-semibold text-grey-600 uppercase tracking-wider block mb-2">Marca</label>
              <select id="filter-marca" class="w-full px-3 py-2 text-sm border border-grey-200 rounded-md outline-none focus:border-primary-500">
                <option value="">Todas</option>
                {marcas.map(m => <option value={m}>{m}</option>)}
              </select>
            </div>

            <button
              id="filter-reset"
              class="btn-secondary" style="width: 100%; font-size: 0.75rem; padding-top: 0.5rem; padding-bottom: 0.5rem;"
            >
              Limpiar filtros
            </button>
          </div>
        </aside>

        <!-- Product Grid -->
        <div class="flex-1">
          <div class="flex items-center justify-between mb-6">
            <p class="text-sm text-grey-600">
              <span id="product-count">{products.length}</span> productos encontrados
            </p>
            <select id="sort-select" class="text-sm border border-grey-200 rounded-md px-3 py-2 outline-none focus:border-primary-500">
              <option value="newest">Mas recientes</option>
              <option value="price-asc">Precio: menor a mayor</option>
              <option value="price-desc">Precio: mayor a menor</option>
            </select>
          </div>

          <div id="product-grid" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-6">
            {products.map((product) => (
              <div
                class="product-item"
                data-name={product.nombre.toLowerCase()}
                data-cat={product.categoria}
                data-marca={product.marca}
                data-price={product.precio}
              >
                <ProductCard {...product} />
              </div>
            ))}
          </div>

          <!-- Empty state -->
          <div id="empty-state" class="hidden text-center py-16">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-grey-400 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
            <p class="text-grey-600 text-lg">No se encontraron productos con esos filtros</p>
            <button id="empty-reset" class="btn-primary mt-4" style="font-size: 0.75rem;">Limpiar filtros</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  const searchInput = document.getElementById('filter-search') as HTMLInputElement;
  const catSelect = document.getElementById('filter-cat') as HTMLSelectElement;
  const marcaSelect = document.getElementById('filter-marca') as HTMLSelectElement;
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  const resetBtn = document.getElementById('filter-reset');
  const emptyResetBtn = document.getElementById('empty-reset');
  const grid = document.getElementById('product-grid');
  const countEl = document.getElementById('product-count');
  const emptyState = document.getElementById('empty-state');

  function filterProducts() {
    const search = searchInput?.value.toLowerCase() ?? '';
    const cat = catSelect?.value ?? '';
    const marca = marcaSelect?.value ?? '';
    const items = grid?.querySelectorAll('.product-item') as NodeListOf<HTMLElement>;
    let visible = 0;

    items?.forEach(item => {
      const matchSearch = !search || (item.dataset.name?.includes(search) ?? false);
      const matchCat = !cat || item.dataset.cat === cat;
      const matchMarca = !marca || item.dataset.marca === marca;
      const show = matchSearch && matchCat && matchMarca;
      item.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    if (countEl) countEl.textContent = String(visible);
    if (emptyState) emptyState.classList.toggle('hidden', visible > 0);
    if (grid) grid.classList.toggle('hidden', visible === 0);
  }

  function resetFilters() {
    if (searchInput) searchInput.value = '';
    if (catSelect) catSelect.value = '';
    if (marcaSelect) marcaSelect.value = '';
    filterProducts();
  }

  // URL query param support
  const params = new URLSearchParams(window.location.search);
  const q = params.get('q');
  if (q && searchInput) {
    searchInput.value = q;
  }

  searchInput?.addEventListener('input', filterProducts);
  catSelect?.addEventListener('change', filterProducts);
  marcaSelect?.addEventListener('change', filterProducts);
  resetBtn?.addEventListener('click', resetFilters);
  emptyResetBtn?.addEventListener('click', resetFilters);

  filterProducts();
</script>
